<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üåç Multilingual News Explorer</title>
  <meta name="color-scheme" content="light dark">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- Header -->
  <header class="bg-white shadow p-4">
    <div class="max-w-5xl mx-auto flex items-center justify-between">
      <h1 class="text-xl font-bold">üåç Multilingual News Explorer</h1>
      <div class="flex gap-3 items-center text-sm">
        <button id="checkBtn" class="text-indigo-600 hover:underline">Check connection</button>
        <label class="inline-flex items-center gap-2">
          <input id="mockToggle" type="checkbox" class="accent-indigo-600">
          <span class="text-gray-600">Mock mode</span>
        </label>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-5xl mx-auto p-6">
    <!-- Search -->
    <section class="bg-white p-4 rounded-xl shadow">
      <label for="query" class="block text-sm font-medium">Search in any language</label>
      <div class="mt-2 flex gap-2">
        <input id="query" type="text" placeholder="e.g., AI transparency rules"
                class="flex-1 border rounded-lg px-3 py-2 bg-white text-black placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"/>

        <button id="searchBtn"
                class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 disabled:opacity-60">
          Search
        </button>
      </div>
      
    </section>
    <select id="langFilter" class="border rounded-lg px-2 py-1 bg-white text-black focus:outline-none focus:ring-2 focus:ring-indigo-500">
      <option value="">All Languages</option>
      <option value="en">English</option>
      <option value="de">German</option>
      <option value="es">Spanish</option>
      <option value="fr">French</option>
      <option value="it">Italian</option>
      <option value="pt">Portuguese</option>
      <option value="hi">Hindi</option>
      <option value="ja">Japanese</option>
      
    </select>
    <!-- Status -->
    <div id="status" class="mt-4 text-sm text-gray-600"></div>

    <!-- Results -->
    <section class="mt-6">
      <h2 class="text-lg font-semibold mb-3">Results</h2>
      <div id="results" class="grid gap-4"></div>
    </section>

    <!-- Debug panel -->
    <section class="mt-6">
      <details>
        <summary class="text-sm text-gray-700 cursor-pointer">Show debug console</summary>
        <pre id="debug" class="mt-2 p-3 bg-gray-900 text-gray-100 rounded text-xs overflow-auto"></pre>
      </details>
    </section>
  </main>

  <script>
  // If served from GitHub Pages or your domain, use PROD; otherwise use local Flask.
  const PROD_ENDPOINT = "https://multilingualnews.fly.dev/"; // e.g. https://multinews.fly.dev
  const ENDPOINT =
    (location.hostname.endsWith("github.io")) 
      ? PROD_ENDPOINT
      : "http://127.0.0.1:5000";

  const statusEl  = document.getElementById("status");
  const resultsEl = document.getElementById("results");
  const debugEl   = document.getElementById("debug");
  const btn       = document.getElementById("searchBtn");
  const input     = document.getElementById("query");
  const checkBtn  = document.getElementById("checkBtn");
  const mockTgl   = document.getElementById("mockToggle");
  const langFilter = document.getElementById("langFilter");  // ‚¨Ö NEW

  let lastResults = []; // store raw results for filtering ‚¨Ö NEW

  // Debug helpers
  function logDbg(...args) {
    const line = args.map(a => typeof a === 'string' ? a : JSON.stringify(a)).join(' ');
    if (debugEl) debugEl.textContent += line + "\n";
    console.log(...args);
  }

  window.onerror = (msg, src, line, col, err) => {
    logDbg("[Error]", msg, src, line + ":" + col, err && (err.stack || err));
  };
  window.onunhandledrejection = (e) => {
    logDbg("[Promise rejection]", e.reason || e);
  };

  // Mock data
  const mockArticles = [
    { title: "EU unveils new AI Act rules for model transparency",
      summary: "The European Union introduced updates to the AI Act...",
      lang: "en", url: "https://example.com/eu-ai",
      source: "Example", published_at: "2025-08-18T10:00:00Z", score: 0.913 },
    { title: "L'UE pr√©sente de nouvelles r√®gles de transparence pour l'IA",
      summary: "De nouvelles exigences visent les grands mod√®les...",
      lang: "fr", url: "https://example.com/fr-eu-ai",
      source: "Exemple", published_at: "2025-08-17T09:00:00Z", score: 0.884 },
    { title: "La UE anuncia reglas para la transparencia en IA",
      summary: "Las nuevas normas buscan asegurar la trazabilidad...",
      lang: "es", url: "https://example.com/es-eu-ai",
      source: "Ejemplo", published_at: "2025-08-16T08:30:00Z", score: 0.861 }
  ];

  function fmtDate(iso) {
    if (!iso) return "";
    try { return new Date(iso).toLocaleString(); } catch { return iso; }
  }

  function skeletonCards(n = 3) {
    resultsEl.innerHTML = "";
    for (let i = 0; i < n; i++) {
      const sk = document.createElement("div");
      sk.className = "bg-white p-4 rounded-lg shadow animate-pulse";
      sk.innerHTML = `
        <div class="h-4 bg-gray-200 rounded w-3/4 mb-3"></div>
        <div class="h-3 bg-gray-200 rounded w-full mb-2"></div>
        <div class="h-3 bg-gray-200 rounded w-5/6 mb-4"></div>
        <div class="h-3 bg-gray-200 rounded w-1/3"></div>
      `;
      resultsEl.appendChild(sk);
    }
  }

  function renderArticles(items) {
    resultsEl.innerHTML = "";
    if (!items || items.length === 0) {
      resultsEl.innerHTML = `<p class="text-gray-500">No results found.</p>`;
      return;
    }
    items.forEach(a => {
      const card = document.createElement("div");
      card.className = "bg-white p-4 rounded-lg shadow hover:shadow-md transition"; // ‚¨Ö added hover polish
      const safeScore = typeof a.score === "number" ? a.score.toFixed(3) : "";
      const metaBits = [a.source || "", a.published_at ? fmtDate(a.published_at) : "", safeScore ? `score ${safeScore}` : ""]
        .filter(Boolean).join(" ¬∑ ");

      const text = a.summary_short || a.summary || "";
      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <h3 class="font-semibold text-lg">
            <a href="${a.url || '#'}" target="_blank" class="hover:underline">${a.title || "(untitled)"}</a>
          </h3>
          ${a.lang ? `<span class="text-[10px] px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-200">${a.lang.toUpperCase()}</span>` : ""}
        </div>
        <p class="text-sm text-gray-600 mt-1 line-clamp-3">${text}</p>
        ${metaBits ? `<div class="text-xs text-gray-500 mt-2">${metaBits}</div>` : ""}
      `;

      resultsEl.appendChild(card);
    });
  }

  function applyFilter() {
  const filter = langFilter.value;
  const filtered = filter
    ? lastResults.filter(a => (a.lang || "").toLowerCase() === filter)
    : lastResults;
  
  // fallback: if filter kills everything, still show all
  if (filtered.length === 0 && filter) {
    renderArticles(lastResults);
    statusEl.textContent = `No results matched filter (${filter.toUpperCase()})`;
  } else {
    renderArticles(filtered);
  }
}


  async function checkConnection(){
    statusEl.textContent = "Probing API‚Ä¶";
    try{
      const r = await fetch(ENDPOINT + "/health");
      const t = await r.json().catch(()=> ({}));
      statusEl.textContent = r.ok
        ? `Connected: ${ENDPOINT} ¬∑ articles=${t.articles ?? "?"} ¬∑ embeddings=${t.embeddings_shape ? "yes" : "no"}`
        : `Health failed (${r.status})`;
    }catch(e){
      statusEl.textContent = "Probe failed: " + (e && e.message ? e.message : e);
      logDbg("[check] error", e && (e.stack || e));
    }
  }

  async function searchNews(){
    const q = input.value.trim();
    if(!q) return;

    btn.disabled = true;
    statusEl.textContent = "Searching‚Ä¶";
    skeletonCards();

    try{
      let data;
      if (mockTgl && mockTgl.checked) {
        const ql = q.toLowerCase();
        data = mockArticles.filter(a =>
          (a.title || "").toLowerCase().includes(ql) ||
          (a.summary || "").toLowerCase().includes(ql)
        );
        await new Promise(r => setTimeout(r, 300));
      } else {
        const lang = langFilter.value;
        const url = `${ENDPOINT}/search?q=${encodeURIComponent(q)}&k=10${lang ? `&lang=${lang}` : ""}`;

        const controller = new AbortController();
        const to = setTimeout(() => controller.abort(), 15000);
        const res = await fetch(url, {
          method: "GET",
          headers: API_KEY ? { "x-api-key": API_KEY } : {},
          signal: controller.signal
        });
        clearTimeout(to);
        if(!res.ok){
          const txt = await res.text().catch(()=> "");
          throw new Error(`API ${res.status}: ${txt || res.statusText}`);
        }
        data = await res.json();
      }
      lastResults = Array.isArray(data) ? data : [];  // ‚¨Ö store results
      applyFilter(); // ‚¨Ö render with filter
      statusEl.textContent = `Found ${lastResults.length} result(s).`;
    }catch(err){
      logDbg("[search] error", err && (err.stack || err));
      resultsEl.innerHTML = `
        <div class="bg-red-50 border border-red-200 text-red-700 p-4 rounded">
          <div class="font-semibold mb-1">Request failed</div>
          <div class="text-sm">${(err && err.message) || err}</div>
          <div class="text-xs text-gray-500 mt-2">
            Make sure the backend is running. If your URL changed, update ENDPOINT at the top of this file.
          </div>
        </div>`;
      statusEl.textContent = "";
    }finally{
      btn.disabled = false;
    }
  }

  // Wire events
  btn.addEventListener("click", searchNews);
  input.addEventListener("keydown", (e) => { if (e.key === "Enter") searchNews(); });
  checkBtn.addEventListener("click", checkConnection);
  langFilter.addEventListener("change", applyFilter); // ‚¨Ö NEW
</script>

</body>
</html>
